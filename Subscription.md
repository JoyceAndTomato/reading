# Subscription of Revenue Cloud

Revenue Cloud provides on the one hand a multi tenant SaaS UI which can be accessed through a tenant-independent landing page 
and on the other hand externally available APIs. The current assumption is that when a customer buys Revenue Cloud, he will
only be able to buy the whole solution, UI + APIs. 

Still the registration of UI and API solutions on CF are currently slightly different. UI applications are called *multi tenant SaaS applications* 
and require a binding to a `LPS SaaS registry` instance of plan `application`. Applications exposing external APIs are called
*SaaS ReUse services* and consist of the application itself and a service broker. They also require a binding to a `LPS SaaS registry` instance
but it needs to use the `broker` plan.

A detailed explanation on SaaS Application Registration in CF can be found [here](https://wiki.wdf.sap.corp/wiki/display/CPC15N/SaaS+Application+Registration+in+CF).

To our knowledge it is possible to have one single application functioning as a *multi tenant SaaS application* as well as a *SaaS ReUse service*.
Although from registration perspective they are almost the same, the application still needs to bind both `LPS SaaS registry` instances.
Therefore to subscribe the whole Revenue Cloud solution, two subscriptions will be necessary (UI + API). 

## Callback Implementation

The subscription callbacks were implemented in Jupiter according to the previously mentioned process. In the following the 
received information will be documented.

### Get Dependencies

For now, our *get dependencies callback* only returns an empty array as we do not have any dependencies in our solution.
As soon as we use other CF services, we will need to adapt the endpoint. The response value for this endpoint will look 
like this: 

```
[
    {
        "appId": "<value>",     // The xsappname of the reuse service which the application consumes.
                                // It can be found in the environment variables of the application:
                                // VCAP_SERVICES.<service>.credentials.xsappname
        "appName": "<value>"    // The name of the service broker in LPS (Should be received from 
                                // the reuse service broker which registered to LPS)
    },
    ....
]   
```

### Subscribe Tenant

When a tenant subscribes to Revenue Cloud the *subscribe tenant callback* is called containing the tenant information in the request body.
Here we can implement all onboarding procedures relevant for Revenue Cloud tenants. The tenant information looks as follows (example):

```
{
	"subscriptionAppId": "revenue-cloud!t1532",                     // The application ID of the main subscribed application.
	                                                                // Generated by XSUAA based on the xsappname.
	"subscriptionAppName": "revenue-cloud",                         // The application name of the main subscribed application.
	"subscribedTenantId": "63f12bba-6f21-4983-86dc-6b81f564b633",   // ID of the subscription tenant
	"subscribedSubdomain": "revenue-cloud-customer-test",           // The subdomain of the subscription tenant (hostname for 
	                                                                // the identityzone).
	"subscriptionAppPlan": "test_code",                             // The plan of the main subscribed application defined in CIS. 
	                                                                // Application + Plan identified by the SKU
	"subscriptionAppAmount": "0",                                   // Amount that the customer entitled to in CIS.
	"dependantServiceInstanceAppIds" : ["<value>", "..."],          // List of oAuth client IDs of the subscribed service instance
	                                                                // of a reuse service. Will be empty for SaaS application.
	  "additionalInformation": {                                    
        "tenantMetadataUrl": "https://revenue-cloud-customer-test.authentication.eu10.hana.ondemand.com/saml/metadata"
        
        // Further attributes:
        // ONLY for applications using XSUAA with "tenant-mode: external"
        // (in xs-security.json): Additional information from XSUAA about
        // the subscription. Basically these properties are required to
        // connect to the application from outside the Cloud Foundry
        // environment, typically from the Neo environment via destination.
      }
}



```

### Unsubscribe Tenant

When a tenant is offboarded the *unsubscribe tenant callback* is called containing the tenant information in the request body. 
Here we can implement all offboarding procedures relevant for Revenue Cloud tenants. The tenant information looks as follows (example):

```
{
     "subscriptionAppId": "revenue-cloud!t1532",                      // The application id of the main subscribed application.
                                                                      // Generated by XSUAA based on the xsappname.
     "subscriptionAppName": "revenue-cloud",
     "subscribedTenantId": "63f12bba-6f21-4983-86dc-6b81f564b633",    // Id of the subscription tenant
     "subscribedSubdomain": "revenue-cloud-customer-test",            // The subdomain of the subscription tenant.
     "subscriptionAppPlan": "test_code",                              // The plan of the main subscribed application defined in CIS.
     "subscriptionAppAmount": "0"
}
```